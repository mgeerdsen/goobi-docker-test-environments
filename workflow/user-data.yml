#cloud-config
swap:
  filename: "/swapfile"
  size: auto
  maxsize: 4294967296
apt:
  preserve_sources_list: true
  sources:
    docker-ce:
      source: "deb https://download.docker.com/linux/ubuntu $RELEASE stable"
      keyid: "9DC858229FC7DD38854AE2D88D81803C0EBFCD88"
    
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg-agent
  - software-properties-common
  - htop
  - tmux
  - docker-ce
  - docker-ce-cli
  - containerd.io
  - docker-compose-plugin

write_files:
  # content can be generated by "cat docker-compose.yml | gzip | base64 -w0"
  - encoding: gz+b64
    content: |
      H4sIAAAAAAAAA51TwY7aMBC98xUjOAez6qGrSD2wglsrWrJt1VPkxEOwcDyu7YTy9zVJSgIbWtRLpDy/mXnzZqZG6yTpGKbv5u+nE4e2ljm6eAJQEGUyOpI97BQdzwjAbAaVQzAWs0oqD7LkBcJR+j0I3PEqQEZVhdSu5TfvMUjtLdeCs5ucXUzUxTQhhqzvogEimD4vnhfx+TNtsJpUVeKA4E8mVGjhDgRwVNk8wE29tETPBff88uy5LdDHwMh4JmQh62ADterYDfuhCvjrLHtHSqD9V5Va4hEt29M1P1hbUqU9KMq5AiEt5p6sRNf623kEwUfISe9k8ceD2UVjJrW4gL1G1qRkhvs988TKU9fp0PY24q/G3NL/s2or/tGiAzbqWlrSJWrfj3/1kibr7bf19sP1bkUiazgCDWrh0vOOX4LGqRZdkBKEVFqhc5HzZAyKyZtbCAFX611yK3nAnhbzp3tKP/1IvnxMt5vNa/p5mSTfN9tVtzxXhNXydfmyTNZjb19Do2P4WL47ZzIYVT+oORNZ63aaKa4Pc/dTvV1iQfkBbRRasidD4aIjqaUX2VzciX3ocEQ2fpg1t0zJLGxNSHih3J3QZNDv9c33SFuq/x/ebDz5Da5vzt4JBQAA
    path: /opt/goobi-test/docker-compose.yml
    owner: root:root

package_update: true
package_upgrade: true
users:
  - name: matthias
    ssh_import_id: gh:mgeerdsen
    sudo:  ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    groups: docker

runcmd:
  - [ mkdir, -p, /opt/goobi-test/db]
  - [ wget, -q, -O, /opt/goobi-test/db/goobi_blank.sql, https://raw.githubusercontent.com/intranda/goobi-workflow/master/Goobi/install/db/goobi_blank.sql]
  - [ docker, compose, -f, /opt/goobi-test/docker-compose.yml, pull ]
  - [ docker, compose, -f, /opt/goobi-test/docker-compose.yml, up, -d, goobi-workflow-db ]
  - [ sleep, 30 ]
  - [ docker, compose, -f, /opt/goobi-test/docker-compose.yml, up, -d, goobi-workflow ]

power_state:
 delay: "+1"
 mode: reboot
 message: Rebooting
 timeout: 30
 condition: True
